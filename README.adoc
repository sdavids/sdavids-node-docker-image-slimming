// SPDX-FileCopyrightText: © 2020 Sebastian Davids <sdavids@gmx.de>
// SPDX-License-Identifier: Apache-2.0
= Node Docker Image Slimming
Sebastian Davids <sdavids@gmx.de>
// Metadata:
:description: Techniques for creating a smaller Node.js Docker image.
// Settings:
:sectnums:
:sectanchors:
:sectlinks:
:toc: macro
:toclevels: 3
:toc-placement!:
:hide-uri-scheme:
:source-highlighter: rouge
:rouge-style: github
:experimental:
// Refs:
:docker-install-url: https://docs.docker.com/install/
:fnm-install-url: https://github.com/Schniz/fnm#installation
:nvm-install-url: https://github.com/nvm-sh/nvm#installing-and-updating

ifdef::env-browser[:outfilesuffix: .adoc]

ifdef::env-github[]
:outfilesuffix: .adoc
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:warning-caption: :warning:
endif::[]

toc::[]

This repository showcases several techniques for creating smaller Node.js Docker images:

. .dockerignore file
. multi-stage build
. smaller base image
. image hardening
. https://upx.github.io[UPX]
. cleaning up `node_modules`
. JavaScript bundling

The link:Dockerfile[example] is an https://expressjs.com[Express]-based REST API packaged in a Docker image with a https://docs.docker.com/reference/dockerfile/#healthcheck[HEALTHCHECK].

****
*TLDR*

1950.0 MB => 93.4 MB (-95.21%)
****

== Techniques

The final result with all techniques applied can be found in the `main` branch:

* link:Dockerfile[]
* link:scripts/docker_build.sh[]

The other branches showcase a single technique--the last commit of the branch contains the changes for the specific technique.

[WARNING]
====
All branches besides `main` will be force-pushed to in order to keep them aligned with the main branch.
====

=== Results

[%header,cols=">1,4,^2m,>2m,>2m,>2m"]
|===

|#
|Branch
| Layer Count
|Image Size (MB)
|node_modules Size (MB)
|server.mjs Size (B)

|0
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/000-base?tab=readme-ov-file#node-docker-image-slimming[000-base]
|33
|1950.0
|140.0
|2139

|1
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/001-dockerignore?tab=readme-ov-file#node-docker-image-slimming[001-dockerignore]
|35
|1770.0
|120.0
|2139

|2
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/002-alpine?tab=readme-ov-file#node-docker-image-slimming[002-alpine]
|31
|382.0
|119.7
|2139

|3
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/003-alpine-npm-ci?tab=readme-ov-file#node-docker-image-slimming[003-alpine-npm-ci]
|31
|233.0
|38.3
|2139

|4
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/004-alpine-clean-modules?tab=readme-ov-file#node-docker-image-slimming[004-alpine-clean-modules]
|31
|217.0
|22.4
|2139

|5
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/005-alpine-multi-stage-build?tab=readme-ov-file#node-docker-image-slimming[005-alpine-multi-stage-build]
|29
|216.0
|22.4
|2139

|6
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/006-alpine-alpine-final?tab=readme-ov-file#node-docker-image-slimming[006-alpine-alpine-final]
|24
|116.0
|22.4
|2139

|7
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/007-alpine-upx?tab=readme-ov-file#node-docker-image-slimming[007-alpine-upx]
|26
|114.0
|22.4
|2139

|8
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/008-alpine-hardening?tab=readme-ov-file#node-docker-image-slimming[008-alpine-hardening]
|30
|114.0
|22.4
|2139

|9
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/009-alpine-webpack?tab=readme-ov-file#node-docker-image-slimming[009-alpine-webpack]
|30
|114.0
|22.4
|1189

|9
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/009-alpine-esbuild-external?tab=readme-ov-file#node-docker-image-slimming[009-alpine-esbuild-external]
|30
|114.0
|22.4
|1136

|9
|https://github.com/sdavids/sdavids-node-docker-image-slimming/tree/009-alpine-esbuild?tab=readme-ov-file#node-docker-image-slimming[009-alpine-esbuild]
|29
|93.4
|0
|4750597

|===

[start=0]
. baseline with the default variant of the https://hub.docker.com/_/node/[offical NodeJS Docker image] for building the image and serving the example REST API with no optimizations
. use a https://docs.docker.com/reference/dockerfile/#dockerignore-file[.dockerignore file] and specific `COPY` commands
+
[NOTE]
====
The https://github.com/sdavids/sdavids-shell-misc?tab=readme-ov-file#212-ls_extensions[ls_extensions] and https://github.com/sdavids/sdavids-shell-misc?tab=readme-ov-file#ls_extensions_git[ls_extensions_git] functions might help fine-tuning your `.dockerignore` file.
====
. use the `alpine` variant of the https://hub.docker.com/_/node/[offical NodeJS Docker image] for both building and running
. use `npm ci --omit dev --omit optional --omit peer` instead of `npm i`
+
[NOTE]
====
Depending on your project setup you might not be able to omit the https://nodejs.org/en/blog/npm/peer-dependencies[peer dependencies].
====
. use the https://www.npmjs.com/package/clean-modules[clean-modules] npm package to clean up the `node_modules` directory
+
[NOTE]
====
`clean-modules` will have more impact once there are more dependencies.
====
. use a multi-stage build
. use the https://hub.docker.com/_/alpine/[official Alpine Docker image] for serving the example REST API
+
[NOTE]
====
Depending on your project setup you might have to install more packages via `apk add --no-cache`.

The dependencies of `docker run --rm alpine apk add nodejs` might be a starting point.
====
. use https://upx.github.io[UPX] to compress the `node` binary
. harden the final `alpine` image
+
[NOTE]
====
Hardening does not only decrease the image size but also makes it significantly more secure.
====
. bundle the example REST API
+
[NOTE]
====
Bundling will have more impact once there are more source files to bundle.
====
.. use https://webpack.js.org[webpack]
.. use https://esbuild.github.io[esbuild]; `esbuild --bundle --minify --packages=external`
+
[NOTE]
====
`esbuild` only supports bundling to _ESM_ if the code and all of its dependencies are _ESM_ modules.
Otherwise, it has to be bundled as _CommonJS_ and in that case top-level `await` is not supported.
====
.. use https://esbuild.github.io[esbuild]; `esbuild --bundle --minify`
+
[NOTE]
====
`esbuild` only supports bundling to _ESM_ if the code and all of its dependencies are _ESM_ modules.
Otherwise, it has to be bundled as _CommonJS_ and in that case top-level `await` is not supported.

Also, minified JavaScript makes debugging production issues harder.
====

=== Running the Example

. Build the Docker image:
+
[,console]
----
$ node --run docker:build
----

. Start the image (HTTP server):
+
[,console]
----
$ node --run docker:start
----
+
=> `http://localhost:3000[http://localhost:3000]`

. Stop the image:
+
[,console]
----
$ node --run docker:stop
----

. Create a self-signed certificate:
+
[,console]
----
$ node --run cert:create
----

. Start the image (HTTPS server):
+
[,console]
----
$ node --run docker:start:secure
----
+
=> `https://localhost:3000[https://localhost:3000]`

=== Example REST API

The example exposes two endpoints:

`/`::
returns a randomly generated user in JSON format

`/-/health/liveness`::
liveness probe

[,console]
----
$ curl http://localhost:3000/
$ curl http://localhost:3000/-/health/liveness
----

[,console]
----
$ curl --insecure https://localhost:3000/
$ curl --insecure https://localhost:3000/-/health/liveness
----

=== More Information

* https://docs.docker.com/reference/dockerfile/#dockerignore-file[.dockerignore file]
* https://docs.docker.com/reference/dockerfile/#copy[Dockerfile - COPY]
* https://hub.docker.com/_/node[node:<version>-alpine]
* https://docs.npmjs.com/cli/v10/commands/npm-ci[npm-ci]
* https://docs.npmjs.com/cli/v10/commands/npm-ci#omit[npm-ci --omit]
* https://docs.npmjs.com/cli/v10/commands/npm-cache[npm-cache]
* https://www.npmjs.com/package/clean-modules[clean-modules]
* https://docs.docker.com/build/building/multi-stage/[Multi-stage builds]
* https://hub.docker.com/_/alpine/[Official Alpine Docker Image]
* https://upx.github.io[UPX]
* https://github.com/ironpeakservices/iron-alpine[iron-alpine]
* https://webpack.js.org[webpack]
* https://esbuild.github.io/getting-started/#bundling-for-node[esbuild - Bundling for node]
* https://github.com/evanw/esbuild/issues/1921[esbuild - Dynamic require not supported]
* https://github.com/evanw/esbuild/issues/253#issuecomment-667601648[esbuild - Support for top-level await]

== Development

=== Start Auto-Reloading Dev Server

[,console]
----
$ node --run start:dev
----

⇒ http://localhost:3000

== Development Environment Setup

=== Installation

==== Docker

Install {docker-install-url}[Docker].

==== Node Version Manager

Install {fnm-install-url}[fnm] or {nvm-install-url}[NVM].

===== fnm

.~/.zprofile
[,zsh]
----
if command -v fnm > /dev/null 2>&1; then
  eval "$(fnm env --use-on-cd)"
fi
----

===== nvm

.~/.zshrc
[,zsh]
----
export NVM_DIR="${HOME}/.nvm"

[ -s "${NVM_DIR}/nvm.sh" ] && . "${NVM_DIR}/nvm.sh"
[ -s "${NVM_DIR}/bash_completion" ] && . "${NVM_DIR}/bash_completion"

if command -v nvm > /dev/null 2>&1; then
  autoload -U add-zsh-hook
  load-nvmrc() {
    local nvmrc_path="$(nvm_find_nvmrc)"
    if [ -n "${nvmrc_path}" ]; then
      local nvmrc_node_version=$(nvm version "$(cat "${nvmrc_path}")")
      if [ "${nvmrc_node_version}" = "N/A" ]; then
        nvm install
      elif [ "${nvmrc_node_version}" != "$(nvm version)" ]; then
        nvm use
      fi
    elif [ -n "$(PWD=$OLDPWD nvm_find_nvmrc)" ] && [ "$(nvm version)" != "$(nvm version default)" ]; then
      echo 'Reverting to nvm default version'
      nvm use default
    fi
  }

  add-zsh-hook chpwd load-nvmrc
  load-nvmrc
fi
----
