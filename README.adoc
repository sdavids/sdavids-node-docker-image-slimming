// SPDX-FileCopyrightText: © 2020 Sebastian Davids <sdavids@gmx.de>
// SPDX-License-Identifier: Apache-2.0
= Node Docker Image Slimming
Sebastian Davids <sdavids@gmx.de>
// Metadata:
:description: Techniques for creating a smaller Node.js Docker image.
// Settings:
:sectnums:
:sectanchors:
:sectlinks:
:toc: macro
:toclevels: 3
:toc-placement!:
:hide-uri-scheme:
:source-highlighter: rouge
:rouge-style: github
:experimental:
// Refs:
:docker-install-url: https://docs.docker.com/install/
:fnm-install-url: https://github.com/Schniz/fnm#installation
:nvm-install-url: https://github.com/nvm-sh/nvm#installing-and-updating

ifdef::env-browser[:outfilesuffix: .adoc]

ifdef::env-github[]
:outfilesuffix: .adoc
:note-caption: :information_source:
:important-caption: :heavy_exclamation_mark:
:warning-caption: :warning:
endif::[]

toc::[]

This repository showcases several techniques for creating smaller Node.js Docker images:

. _.dockerignore_ file
. `npm ci`
. clean `node_modules`
. multi-stage build
. smaller base image
. image hardening
. https://upx.github.io[UPX]
. JavaScript bundling

The link:Dockerfile[example] is an https://expressjs.com[Express]-based REST API packaged in a Docker image with a https://docs.docker.com/reference/dockerfile/#healthcheck[HEALTHCHECK].

****
*TLDR*

1770 MB => 105 MB (-94,07%)
****

== Techniques

The final result with all techniques applied can be found in the `main` branch:

* link:Dockerfile[]
* link:scripts/docker_build.sh[]

The other branches showcase a single technique--the last commit of the branch contains the changes for the specific technique.

[WARNING]
====
All branches besides `main` will be force-pushed to keep them aligned with the main branch.
====

=== Results

[%header,cols=">1,4,^2m,>2m,>2m,>2m"]
|===

|#
|Branch
|Layer Count
|Image Size (MB)
|node_modules Size (MB)
|server.mjs Size (B)

|0
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/000-baseline/README-branch.adoc[000-baseline]
|22
|1770
|44.0
|2515

|1
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/001-dockerignore/README-branch.adoc[001-dockerignore]
|24
|1660
|24.0
|2515

|2
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/002-npm-ci/README-branch.adoc[002-npm-ci]
|24
|1630
|14.0
|2515

|3
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/003-clean-modules/README-branch.adoc[003-clean-modules]
|24
|1630
|11.0
|2515

|4
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/004-alpine/README-branch.adoc[004-alpine]
|21
|243
|10.9
|2515

|5
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/005-alpine-multi-stage-build/README-branch.adoc[005-alpine-multi-stage-build]
|15
|239
|10.9
|2515

|6
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/006-alpine-alpine-final/README-branch.adoc[006-alpine-alpine-final]
|15
|201
|10.9
|2515

|7
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/007-alpine-hardening/README-branch.adoc[007-alpine-hardening]
|17
|201
|10.9
|2515

|8
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/008-alpine-upx/README-branch.adoc[008-alpine-upx]
|17
|117
|10.9
|2515

|9
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/009-alpine-esbuild-external/README-branch.adoc[009-alpine-esbuild-external]
|17
|117
|10.9
|2003

|10
|https://github.com/sdavids/sdavids-node-docker-image-slimming/blob/010-alpine-esbuild/README-branch.adoc[010-alpine-esbuild]
|16
|105
|0
|1325646

|===

[start=0]
. baseline with the default variant of the https://hub.docker.com/_/node/[official Node.js Docker image] for building the image and serving the example REST API with no optimizations
. uses a https://docs.docker.com/reference/dockerfile/#dockerignore-file[.dockerignore] file and specific `COPY` commands
+
[NOTE]
====
The https://sdavids.github.io/sdavids-shell-misc/user-guide/functions/general/ls-extensions.html[ls_extensions] and https://sdavids.github.io/sdavids-shell-misc/user-guide/functions/git/ls-extensions-git.html[ls_extensions_git] functions might help fine-tuning your `.dockerignore` file.
====
. uses `npm ci --omit=dev --omit=optional --omit=peer` instead of `npm i`
+
[NOTE]
====
Depending on your project setup, you might not be able to omit the
https://nodejs.org/en/blog/npm/peer-dependencies[peer dependencies].
====
. uses the https://www.npmjs.com/package/clean-modules[clean-modules] npm package to clean up the `node_modules` directory
+
[NOTE]
====
`clean-modules` will have more impact once there are more dependencies.
====
. uses the `alpine` variant of the https://hub.docker.com/_/node/[official Node.js Docker image] for both building and running
. uses a multi-stage build
. uses the https://hub.docker.com/_/alpine/[official Alpine Docker image] for serving the example REST API
+
[NOTE]
====
Depending on your project setup you might have to install more packages via `apk add --no-cache`.

The dependencies of `docker run --rm alpine apk add nodejs` might be a starting point.
====
. hardens the final `alpine` image
+
[NOTE]
====
Hardening slightly decreases the image's size but makes it significantly more secure.
====
. uses https://upx.github.io[UPX] to compress the `node` binary
. bundles the example REST API with https://esbuild.github.io[esbuild]: `esbuild --bundle --minify --packages=external`
+
[NOTE]
====
Bundling will have more impact once there are more source files to bundle.

`esbuild` only supports bundling to _ESM_ if the code and all of its dependencies are _ESM_ modules.
Otherwise, it has to be bundled as _CommonJS_ and in that case top-level `await` is not supported.

Also, minified JavaScript makes debugging production issues harder.
====
. bundles the example REST API with https://esbuild.github.io[esbuild]: `esbuild --bundle --minify`
+
[NOTE]
====
Bundling will have more impact once there are more source files to bundle.

`esbuild` only supports bundling to _ESM_ if the code and all of its dependencies are _ESM_ modules.
Otherwise, it has to be bundled as _CommonJS_ and in that case top-level `await` is not supported.

Also, minified JavaScript makes debugging production issues harder.
====

=== Running the Example

. Build the Docker image:
+
[,console]
----
$ node --run docker:build
----

. Start the image (HTTP server):
+
[,console]
----
$ node --run docker:start
----
+
=> `http://localhost:3000[http://localhost:3000]`

. Stop the image:
+
[,console]
----
$ node --run docker:stop
----

. Create a self-signed certificate:
+
[,console]
----
$ node --run cert:create
----

. Start the image (HTTPS server):
+
[,console]
----
$ node --run docker:start:secure
----
+
=> `https://localhost:3000[https://localhost:3000]`

=== Example REST API

The example exposes two endpoints:

`/`::
returns a randomly generated user in JSON format

`/-/health/liveness`::
liveness probe

[,console]
----
$ curl http://localhost:3000/
$ curl http://localhost:3000/-/health/liveness
----

[,console]
----
$ curl --insecure https://localhost:3000/
$ curl --insecure https://localhost:3000/-/health/liveness
----

=== More Information

* https://docs.docker.com/reference/dockerfile/#dockerignore-file[.dockerignore file]
* https://docs.docker.com/reference/dockerfile/#copy[Dockerfile COPY]
* https://hub.docker.com/_/node[node:<version>-alpine]
* https://docs.npmjs.com/cli/v10/commands/npm-ci[npm-ci]
* https://docs.npmjs.com/cli/v10/commands/npm-ci#omit[npm-ci --omit]
* https://docs.npmjs.com/cli/v10/commands/npm-cache[npm-cache]
* https://www.npmjs.com/package/clean-modules[clean-modules]
* https://docs.docker.com/build/building/multi-stage/[Multi-stage builds]
* https://hub.docker.com/_/alpine/[Official Alpine Docker Image]
* https://upx.github.io[UPX]
* https://github.com/ironpeakservices/iron-alpine[iron-alpine]
* https://webpack.js.org[webpack]
* https://esbuild.github.io/getting-started/#bundling-for-node[esbuild - Bundling for node]
* https://github.com/evanw/esbuild/issues/1921[esbuild - Dynamic require not supported]
* https://github.com/evanw/esbuild/issues/253#issuecomment-667601648[esbuild - Support for top-level await]

== Development

=== Start Auto-Reloading Dev Server

[,console]
----
$ node --run start:dev
----

⇒ http://localhost:3000

== Development Environment Setup

=== Installation

==== Docker

Install {docker-install-url}[Docker].

==== Node Version Manager

Install {fnm-install-url}[fnm] or {nvm-install-url}[NVM].

===== fnm

.~/.zprofile
[,zsh]
----
if command -v fnm > /dev/null 2>&1; then
  eval "$(fnm env --use-on-cd)"
fi
----

===== nvm

.~/.zshrc
[,zsh]
----
export NVM_DIR="${HOME}/.nvm"

[ -s "${NVM_DIR}/nvm.sh" ] && . "${NVM_DIR}/nvm.sh"
[ -s "${NVM_DIR}/bash_completion" ] && . "${NVM_DIR}/bash_completion"

if command -v nvm > /dev/null 2>&1; then
  autoload -U add-zsh-hook
  load-nvmrc() {
    local nvmrc_path="$(nvm_find_nvmrc)"
    if [ -n "${nvmrc_path}" ]; then
      local nvmrc_node_version=$(nvm version "$(cat "${nvmrc_path}")")
      if [ "${nvmrc_node_version}" = "N/A" ]; then
        nvm install
      elif [ "${nvmrc_node_version}" != "$(nvm version)" ]; then
        nvm use
      fi
    elif [ -n "$(PWD=$OLDPWD nvm_find_nvmrc)" ] && [ "$(nvm version)" != "$(nvm version default)" ]; then
      echo 'Reverting to nvm default version'
      nvm use default
    fi
  }

  add-zsh-hook chpwd load-nvmrc
  load-nvmrc
fi
----
